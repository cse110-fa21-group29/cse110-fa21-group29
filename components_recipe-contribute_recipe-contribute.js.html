<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>components/recipe-contribute/recipe-contribute.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Database.html">Database</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#deleteRecipe">deleteRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#getRecipe">getRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#getRecipes">getRecipes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#pushRecipe">pushRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#searchByName">searchByName</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#updateRecipe">updateRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#writeData">writeData</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="HomePage.html">HomePage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HomePage.html#buttonEventListener">buttonEventListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HomePage.html#createRecipeCard">createRecipeCard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HomePage.html#recipeScroll">recipeScroll</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="HomePage.html#setupElement">setupElement</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MealPlanner.html">MealPlanner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#addButtonToCell">addButtonToCell</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#addRecipeToCell">addRecipeToCell</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#addRecipeToCellWithDB">addRecipeToCellWithDB</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#drop">drop</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#getParams">getParams</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#search">search</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#setupElement">setupElement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#setUrl">setUrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MealPlanner.html#updateNutrition">updateNutrition</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MealPlannerRecipeCard.html">MealPlannerRecipeCard</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RecipeContribute.html">RecipeContribute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeContribute.html#addRecipe">addRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeContribute.html#editRecipe">editRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeContribute.html#getVideoEmbedURL">getVideoEmbedURL</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeContribute.html#saveRecipe">saveRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeContribute.html#setupElement">setupElement</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RecipeDetails.html">RecipeDetails</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeDetails.html#setupElement">setupElement</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeDetails.html#switchToText">switchToText</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeDetails.html#switchToVideo">switchToVideo</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="SidebarRecipeCard.html">SidebarRecipeCard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SidebarRecipeCard.html#setupElement">setupElement</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Storage.html">Storage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Storage.html#deleteImage">deleteImage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Storage.html#uploadImage">uploadImage</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="YummyRecipesComponent_YummyRecipesComponent.html">YummyRecipesComponent</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-core_routing_router.html">core/routing/router</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-core_routing_router.html#~getParamsFromUrl">getParamsFromUrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-core_routing_router.html#~getRoutefromUrl">getRoutefromUrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-core_routing_router.html#~getUrlFromRoute">getUrlFromRoute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-core_routing_router.html#~loadRoute">loadRoute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-core_routing_router.html#~navigateFromUrl">navigateFromUrl</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-core_routing_router.html#~routerSetup">routerSetup</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">components/recipe-contribute/recipe-contribute.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Database } from "/core/database/database.js";
import { Storage } from "/core/storage/storage.js";
import { YummyRecipesComponent } from "/components/core/yummy-recipes-component.js";

/** Class that provides functionality to the recipe contribute page. */
class RecipeContribute extends YummyRecipesComponent {
  constructor() {
    super();
    this.htmlPath = "components/recipe-contribute/recipe-contribute.html";

    // Flag to determine if image was input in the form
    this.imageChanged = false;
  }

  /**
   * Sets up contribute page functionality depending on if creating or updating
   * recipe.
   *
   * @async
   */
  async setupElement() {
    // Set up page for adding recipe or editing recipe depending on route
    if (this.routeName === "recipe-contribute-add") {
      this.addRecipe();
    } else {
      this.editRecipe();
    }

    // Change event listener for file button
    this.shadowRoot
      .getElementById("submit-img")
      .addEventListener("change", (event) => {
        // Get selected file object
        const file = event.target.files[0];

        // Regex to check if valid image
        const validExt = /(\.jpg|\.jpeg|\.png|\.gif)$/i;

        // File was selected successfully and is valid image
        if (file != undefined &amp;&amp; validExt.exec(file.name)) {
          // Preview image selected using button background
          const img = URL.createObjectURL(file);
          this.shadowRoot.getElementById("submit-img").style.backgroundImage =
            "url(" + img + ")";
          this.shadowRoot.getElementById("submit-img-label").style.display =
            "none";
          // Image file was input into form so set flag to true
          this.imageChanged = true;
        } else {
          // Reset preview
          event.target.style.backgroundImage =
            "url('/static/common/defaultimg.jpeg')";

          // Set flag to false
          this.imageChanged = false;

          // If file was invalid instead of user hitting cancel
          if (file != undefined &amp;&amp; !validExt.exec(file.name)) {
            alert("File must be .jpg, .jpeg, .png, or .gif");
          }
        }
      });

    /**
     * Video field handler to check if link is valid YouTube video or field
     * is empty. Regex from https://stackoverflow.com/a/9102270.
     */
    const videoUrlInput = this.shadowRoot.getElementById("input-video-url");

    videoUrlInput.addEventListener("input", () => {
      // Get form value
      const url = videoUrlInput.value;

      // If video field is blank then allow it and return
      if (url === "") {
        videoUrlInput.setCustomValidity("");
        return;
      }

      // Get regex
      const regExp =
        /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&amp;v=)([^#&amp;?]*).*/;
      const match = url.match(regExp);

      // If regex worked and video ID is 11 characters then link is valid
      if (match &amp;&amp; match[2].length === 11) {
        videoUrlInput.setCustomValidity("");
      } else {
        videoUrlInput.setCustomValidity("Video link is not valid.");
      }
    });
  }

  /**
   * Sets up the page for adding a new recipe.
   *
   * @async
   */
  async addRecipe() {
    // Empty object that will get populated using form values
    const recipe = {
      metadata: {
        id: -1,
        title: "",
        author: "",
        image: "static/common/demorecipe.jpg",
        video: "",
      },
      info: {
        readyInMinutes: 0,
        pricePerServings: 0,
        weightWatcherSmartPoints: 0,
        healthScore: 100,
      },
      categories: {
        vegan: false,
        vegetarian: false,
        glutenFree: false,
        highProtein: false,
        healthy: false,
      },
      nutrients: {
        totalServings: 0,
        calories: 0,
        protein: "",
        fat: "",
      },
      description: "",
      ingredients: [],
      steps: [],
      spoonacularSourceUrl: "",
    };

    // Assign saveRecipe function to submit button
    this.shadowRoot
      .querySelector("#submit-button")
      .addEventListener("click", (event) => {
        event.preventDefault();

        // Display form validation
        const formElement = this.shadowRoot.querySelector("#contribute-form");
        const isFormValid = formElement.checkValidity();
        formElement.reportValidity();

        // Add recipe if form is valid
        if (isFormValid) {
          this.saveRecipe(recipe, true);
        }
      });

    // Add cancel button functionality
    this.shadowRoot
      .querySelector("#cancel-button")
      .addEventListener("click", (event) => {
        event.preventDefault();
        if (confirm("Are you sure you want to cancel?")) {
          // Route to home page
          const routerEvent = new CustomEvent("router-navigate", {
            detail: {
              route: "home-page",
              params: [],
            },
            bubbles: true,
            composed: true,
          });

          document.dispatchEvent(routerEvent);
        }
      });
  }

  /**
   * Sets up the page for editing an existing recipe.
   *
   * @async
   */
  async editRecipe() {
    // Get recipe from database
    const db = new Database();
    const recipe = await db.getRecipe(this.routeParams[0]);

    // If recipe is undefined, go back to home page
    if (!recipe) {
      // Route to home page
      const routerEvent = new CustomEvent("router-navigate", {
        detail: {
          route: "home-page",
          params: [],
        },
        bubbles: true,
        composed: true,
      });

      document.dispatchEvent(routerEvent);
    }

    // Display current recipe image
    this.shadowRoot.getElementById("submit-img").style.backgroundImage =
      "url(" + recipe.metadata.image + ")";

    // Pre-populate form with nutrients
    this.shadowRoot.querySelector("#input-number-of-servings").value =
      recipe.nutrients.totalServings;
    this.shadowRoot.querySelector("#input-colories").value =
      recipe.nutrients.calories;
    this.shadowRoot.querySelector("#input-protein").value =
      recipe.nutrients.protein.slice(0, -1);
    this.shadowRoot.querySelector("#input-fat").value =
      recipe.nutrients.fat.slice(0, -1);

    // Pre-populate form with categories
    this.shadowRoot.querySelector("#input-vegan").checked =
      recipe.categories.vegan;
    this.shadowRoot.querySelector("#input-vegetarian").checked =
      recipe.categories.vegetarian;
    this.shadowRoot.querySelector("#input-gluten-free").checked =
      recipe.categories.glutenFree;
    this.shadowRoot.querySelector("#input-healthy").checked =
      recipe.categories.healthy;
    this.shadowRoot.querySelector("#input-high-protein").checked =
      recipe.categories.highProtein;

    // Pre-populate form with general information
    this.shadowRoot.querySelector("#input-recipe-title").value =
      recipe.metadata.title;
    this.shadowRoot.querySelector("#input-author").value =
      recipe.metadata.author;
    if (recipe.metadata.video != undefined) {
      this.shadowRoot.querySelector("#input-video-url").value =
        recipe.metadata.video;
    }
    this.shadowRoot.querySelector("#input-time").value =
      recipe.info.readyInMinutes;
    this.shadowRoot.querySelector("#input-cost").value =
      recipe.info.pricePerServings;

    // Pre-populate form with description
    this.shadowRoot.querySelector("#input-description").innerText =
      recipe.description;

    // Pre-populate form with ingredients
    const ingredients = recipe.ingredients.join("\n");
    this.shadowRoot.querySelector("#input-ingredient").innerHTML = ingredients;

    // Pre-populate form with directions
    const steps = recipe.steps.join("\n");
    this.shadowRoot.querySelector("#input-direction").innerHTML = steps;

    // Update edited recipe in database on submit button click
    this.shadowRoot
      .querySelector("#submit-button")
      .addEventListener("click", (event) => {
        event.preventDefault();

        // Display form validation
        const formElement = this.shadowRoot.querySelector("#contribute-form");
        const isFormValid = formElement.checkValidity();
        formElement.reportValidity();

        // Update recipe if form is valid
        if (isFormValid) {
          this.saveRecipe(recipe, false);
        }
      });

    // Add cancel button functionality
    this.shadowRoot
      .querySelector("#cancel-button")
      .addEventListener("click", (event) => {
        event.preventDefault();
        if (confirm("Are you sure you want to cancel?")) {
          // Route to recipe details page
          const routerEvent = new CustomEvent("router-navigate", {
            detail: {
              route: "recipe-details",
              params: [this.routeParams[0]],
            },
            bubbles: true,
            composed: true,
          });

          document.dispatchEvent(routerEvent);
        }
      });
  }

  /**
   * Grabs form values, updates recipe object, then pushes object to database.
   * The add parameter should be true if you are adding a new recipe or false
   * if you are updating an existing recipe.
   *
   * @param {Object} recipe - an object that contains the recipe data
   * @param {boolean} add - toggles between creating and updating recipe
   */
  async saveRecipe(recipe, add) {
    // Image
    const storage = new Storage();
    let file = {};
    if (this.imageChanged) {
      file = this.shadowRoot.getElementById("submit-img").files[0];
    }

    // Nutrients
    recipe.nutrients.totalServings = this.shadowRoot.querySelector(
      "#input-number-of-servings"
    ).value;
    recipe.nutrients.calories =
      this.shadowRoot.querySelector("#input-colories").value;
    recipe.nutrients.protein =
      this.shadowRoot.querySelector("#input-protein").value + "g";
    recipe.nutrients.fat =
      this.shadowRoot.querySelector("#input-fat").value + "g";

    // Categories
    recipe.categories.vegan =
      this.shadowRoot.querySelector("#input-vegan").checked;
    recipe.categories.vegetarian =
      this.shadowRoot.querySelector("#input-vegetarian").checked;
    recipe.categories.glutenFree =
      this.shadowRoot.querySelector("#input-gluten-free").checked;
    recipe.categories.highProtein = this.shadowRoot.querySelector(
      "#input-high-protein"
    ).checked;
    recipe.categories.healthy =
      this.shadowRoot.querySelector("#input-healthy").checked;

    // Recipe General Information
    recipe.metadata.title = this.shadowRoot.querySelector(
      "#input-recipe-title"
    ).value;
    recipe.metadata.author =
      this.shadowRoot.querySelector("#input-author").value;
    recipe.metadata.video = this.getVideoEmbedURL(
      this.shadowRoot.querySelector("#input-video-url").value
    );
    recipe.info.readyInMinutes =
      this.shadowRoot.querySelector("#input-time").value;
    recipe.info.pricePerServings =
      this.shadowRoot.querySelector("#input-cost").value;

    // Description
    recipe.description =
      this.shadowRoot.querySelector("#input-description").value;

    // Ingredients
    const ingredients = this.shadowRoot
      .querySelector("#input-ingredient")
      .value.split("\n");

    // Remove empty lines
    const filteredIngredients = ingredients.filter((val) => val);
    recipe.ingredients = filteredIngredients;

    // Directions
    const steps = this.shadowRoot
      .querySelector("#input-direction")
      .value.split("\n");

    // Remove empty lines
    const filteredSteps = steps.filter((val) => val);
    recipe.steps = filteredSteps;

    // Call database functions based on if add or edit function is specified
    const db = new Database();

    if (add) {
      // Push recipe to database and grab index of the new recipe
      const index = await db.pushRecipe(recipe);

      // Upload recipe image if applicable
      if (this.imageChanged) {
        // Upload file named after index in database
        const imageUrl = await storage.uploadImage(file, index);

        // Set image url in recipe
        await db.writeData(imageUrl, index, "metadata/image");
      }

      // Route to new recipe page
      const routerEvent = new CustomEvent("router-navigate", {
        detail: {
          route: "recipe-details",
          params: [index],
        },
        bubbles: true,
        composed: true,
      });

      document.dispatchEvent(routerEvent);
    } else {
      // Get recipe index in database from route param
      const index = this.routeParams[0];

      // Push edited recipe to database
      await db.updateRecipe(recipe, index);

      // Upload recipe image if image updated
      if (this.imageChanged) {
        // Upload file named after index in database
        const imageUrl = await storage.uploadImage(file, index);

        // Set image url in recipe
        await db.writeData(imageUrl, index, "metadata/image");
      }

      // Route to edited recipe page
      const routerEvent = new CustomEvent("router-navigate", {
        detail: {
          route: "recipe-details",
          params: [index],
        },
        bubbles: true,
        composed: true,
      });

      document.dispatchEvent(routerEvent);
    }
  }

  /**
   * Converts a valid YouTube video link into a valid embed link.
   * Regex from https://stackoverflow.com/a/9102270.
   *
   * @param {string} url - A string that represents a YouTube video link.
   * @returns {string} Returns YouTube embed link or empty string if not a valid video URL.
   */
  getVideoEmbedURL(url) {
    const regExp =
      /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&amp;v=)([^#&amp;?]*).*/;
    const match = url.match(regExp);
    if (match &amp;&amp; match[2].length === 11) {
      return "https://www.youtube.com/embed/" + match[2];
    } else {
      return "";
    }
  }
}

customElements.define("recipe-contribute", RecipeContribute);
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Wed Dec 08 2021 08:06:26 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
